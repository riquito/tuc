<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'nonce-378acdg21a' 'nonce-nvkjdnvf34' 'unsafe-eval' ; style-src 'nonce-nu3c532ewd'; img-src data:">
  <title>TUC Playground</title>
  <link rel="icon" href="data:,">
  <script defer src="./polyfill.js" nonce="nvkjdnvf34"></script>
  <style nonce="nu3c532ewd">
    label {
      display: block;
      margin: 4px 0;
      font-size: 1em;
      font-weight: bold;
    }
    html {
      display: flex;
      min-height: 100%;
      background-color: #7d8295;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex: 1 0 auto;
      margin: 0;
      padding: 0;
    }
    main {
      display: flex;
      flex: 1 0 auto;
      flex-direction: column;
      max-width: min(100%, 1280px);
      margin: 0 auto;
      padding: 10px;
      box-sizing: border-box;
    }
    #command-line {
      background-color: #0b0d22;
      color: #63df51;
      font-weight: bold;
      padding: 8px;
      border: 0;
    }
    #command-line::placeholder {
      color: #ccc;
    }
    #input-output-container {
      display: flex;
      flex: 1 0 auto;
      justify-content: space-between;
    }
    #title-cmd {
      display: flex;
      flex: 0 0 auto;
      justify-content: space-between;
    }
    #input-container, #output-container, h1, #cmd-container {
      display: flex;
      flex: 1 0 auto;
      flex-direction: column;
      max-width: 49%;
    }
    #input, #output {
      flex: 1 0 auto;

      background-color: #0b0d22;
      color: #63df51;
      border: 0;
      padding: 8px;
      font-family: mono;
      font-size: 12px;
      max-height: 600px;
    }

    #output {
      white-space: pre;
      overflow-wrap: normal;
      overflow-x: auto;
    }

    h1 {
      margin: 8px 0;
      justify-content: center;
      align-items: center;
      flex-direction: row;
    }

    h1 > a {
      margin-right: 10px;
    }

    #input:focus, #output:focus, #command-line:focus {
      outline-color: #d0c03d;
      outline-style: solid;
      outline-width: medium;
    }

    @media screen and (max-width: 800px) {
      #input-container, #output-container, h1, #cmd-container {
        max-width: initial;
      }
      #input, #output {
        min-height: 200px;
      }

      #title-cmd, #input-output-container {
        flex-direction: column;
        flex: 0 1 auto;
      }

      main {
        padding: 5px;
      }

      #title-cmd {
        max-width: fit-content;
      }
    }
  </style>
</head>
  <main>
    <div id="title-cmd">
      <h1><a href="https://github.com/riquito/tuc">TUC</a> playground</h1>
      <div id="cmd-container">
        <label for="command-line">Command Line (type "tuc -h" if you're lost)</label>
        <input id="command-line" type="text" placeholder="tuc -h" value="tuc -h" />
      </div>
    </div>
    <div id="input-output-container">
      <div id="input-container">
        <label for="input">PIPED INPUT</label>
        <textarea id="input"></textarea>
      </div>
      <div id="output-container">
        <label for="output">OUTPUT</label>
        <textarea id="output" disabled ></textarea>
      </div>
    </div>
  </main>

<script type="module" nonce="378acdg21a">
/**
 * Split a command line string into its components
 *
 * e.g. --foo "hello world" -x '' -d 5
 * => ["--foo", "hello world", "-x", "", "-d", "5"]
 */
function parse_args(args) {
  args = args.trim()

  let parts = ['']
  let in_single_quote = false
  let in_double_quote = false

  for (let c of args) {
    if (c === ' ' && !in_single_quote && !in_double_quote) {
      if (parts[parts.length - 1] !== '') {
        parts.push('')
      }
    } else if (c === '"') {
      if (in_double_quote) {
        // closing quotes, moving to next arg
        in_double_quote = false
        parts.push('')
      } else if (in_single_quote) {
        // no special meaning
        parts[parts.length - 1] += c;
      } else {
        // we are starting a double quoted string
        in_double_quote = true
        if (parts[parts.length - 1] !== '') {
          parts.push('')
        }
      }
    } else if (c === "'") {
      if (in_single_quote) {
        // closing quotes, moving to next arg
        in_single_quote = false
        parts.push('')
      } else if (in_double_quote) {
        // no special meaning
        parts[parts.length - 1] += c;
      } else {
        // we are starting a single quoted string
        in_single_quote = true
        if (parts[parts.length - 1] !== '') {
          parts.push('')
        }
      }
    } else {
      parts[parts.length - 1] += c;
    }
  }

  if (parts.length === 1 && parts[0] === '') {
    return []
  }

  return parts
}

function buildImportModuleData() {
  let already_read = false;

  let stdin = new Stdio({ read: (len) => {
    if (!already_read) {
      already_read = true
      return [new TextEncoder().encode(document.getElementById('input').value), 0]
    } else {
      return [new Uint8Array(), 0]
    }
  }})

  const stdout = new Stdio({ write: (data) => {
    document.getElementById('output').value += new TextDecoder('utf-8').decode(data)
    return 0
  }})

  const stderr = new Stdio({ write: (data) => {
    document.getElementById('output').value += new TextDecoder('utf-8').decode(data)
    return 0
  }})

  let cmd = document.getElementById('command-line').value.trim()
  if (cmd === '' || !cmd.startsWith('tuc')) {
    cmd = "tuc -h"
  }

  const args = parse_args(cmd);
  const env = ['RUSTC_LOG=trace','RUST_BACKTRACE=1'];
  const fds = [
    stdin,
    stdout,
    stderr,
    new PreopenDirectory('/tmp', {}),
  ];

  return [args, env, fds]
}

const debounce = (func, delay) => {
    let previousCallTime = Date.now() - delay
    let prevId = null

    return (...args) => {
      clearTimeout(prevId)
      const now = Date.now()

      if (previousCallTime + delay <= now) {
        func(...args)
      } else {
        prevId = setTimeout(() => func(...args), delay - (now - previousCallTime))
      }

      previousCallTime = Date.now()
    }
}

(async function () {
  const wasmModule = await WebAssembly.compileStreaming(
    fetch('../target/wasm32-wasi/debug/tuc.wasm')
  );

  document.getElementById('input').addEventListener('input', debounce(async (ev) => {
    const [args, env, fds] = buildImportModuleData()
    const inst = await WASM_WASI_instantiate(wasmModule, args, env, fds);
    document.getElementById('output').value = ''

    try {
      inst.exports._start();
    } catch (e) {
      if (e.name !== 'WASIExit') {
        throw e;
      }
    }
  }, 70))

  document.getElementById('command-line').addEventListener('input',  debounce(async (ev) => {
    let [args, env, fds] = buildImportModuleData()
    const inst = await WASM_WASI_instantiate(wasmModule, args, env, fds);
    document.getElementById('output').value = ''

    try {
      inst.exports._start();
    } catch (e) {
      if (e.name !== 'WASIExit') {
        throw e;
      }
    }
  }, 70))
})();

</script>
</html>