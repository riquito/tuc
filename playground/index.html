<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'nonce-378acdg21a' 'nonce-nvkjdnvf34' 'unsafe-eval' ; style-src 'nonce-nu3c532ewd'; img-src data:"> -->
  <title>TUC Playground</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins|Roboto%20Mono|Zen%20Maru%20Gothic">
  <script defer src="./polyfill.js" nonce="nvkjdnvf34"></script>
  <style nonce="nu3c532ewd">
    label {
      display: block;
      margin: 4px 0;
      font-size: 1em;
      font-weight: bold;
    }

    html {
      display: flex;
      min-height: 100%;
      background-color: #040304;
      color: #ffffffcf;
      margin: 0;
      padding: 0;
      font-family: "Poppins", "Avenir", "Helvetica", "Arial", sans-serif;
      font-size: 18px;
    }

    a,
    a:visited {
      color: #4db0d6;
    }

    body {
      display: flex;
      flex: 1 0 auto;
      margin: 0;
      padding: 0;
    }

    main {
      display: flex;
      flex: 1 0 auto;
      flex-direction: column;
      max-width: min(100%, 1366px);
      margin: 0 auto;
      padding: 10px;
      box-sizing: border-box;
    }

    #command-line {
      background-color: #0b0d22;
      color: #63df51;
      font-weight: bold;
      font-size: 16px;
      padding: 8px;
      border: 0;
    }

    #command-line::placeholder {
      color: #ccc;
    }

    #input-output-container {
      display: flex;
      flex: 1 0 auto;
      justify-content: space-between;
      gap: 1rem;
    }

    #title-cmd {
      display: flex;
      flex: 0 0 auto;
      justify-content: space-between;
    }

    #input-container,
    #output-container,
    h1,
    #cmd-container {
      display: flex;
      flex: 1 0 auto;
      flex-direction: column;
    }

    #input-container {
      max-width: min(600px, 49%);
      flex: 0.5 0 auto;
    }

    #input,
    #output {
      flex: 1 0 auto;

      background-color: #44465b;
      color: #fff;
      border: 0;
      padding: 8px;
      font-family: "Roboto Mono", mono;
      font-size: 16px;
      max-height: 600px;
    }

    #output {
      white-space: pre;
      overflow-wrap: normal;
      overflow-x: auto;
      border-radius: 15px;
    }

    #command-line {
      color: black;
      background-color: #a09cb4;

      border-radius: 3px;
      border: 1px solid transparent;
      border-top: none;
      border-bottom: 1px solid #DDD;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, .39), 0 -1px 1px #FFF, 0 1px 0 #FFF;
    }

    #input {
      color: black;
      background-color: #a09cb4;

      border-radius: 3px;
      border: 1px solid transparent;
      border-top: none;
      border-bottom: 1px solid #DDD;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, .39), 0 -1px 1px #FFF, 0 1px 0 #FFF;
    }


    h1 {
      margin: 8px 0;
      justify-content: center;
      align-items: center;
      flex-direction: row;
    }

    h1>a {
      margin-right: 10px;
      font-family: "Zen Maru Gothic";
      letter-spacing: 10px;
      font-size: 48px;
    }

    #input:focus,
    #output:focus,
    #command-line:focus {
      outline-color: #3d5bd0;
      outline-style: solid;
      outline-width: 4px;
    }

    @media screen and (max-width: 800px) {

      #input-container,
      #output-container,
      h1,
      #cmd-container {
        max-width: initial;
      }

      #input,
      #output {
        min-height: 200px;
      }

      #title-cmd,
      #input-output-container {
        flex-direction: column;
        flex: 0 1 auto;
      }

      main {
        padding: 5px;
      }

      #title-cmd {
        max-width: fit-content;
      }
    }
  </style>
</head>
<main>
  <div id="title-cmd">
    <h1><a href="https://github.com/riquito/tuc">TUC</a> playground</h1>
    <div id="cmd-container">
      <label for="command-line">Command Line (type "tuc -h" if you're lost)</label>
      <input id="command-line" type="text" placeholder="tuc -h" value="tuc -d / -f '1,-1' --json" autofocus />
    </div>
  </div>
  <div id="input-output-container">
    <div id="input-container">
      <label for="input">(PIPED) INPUT</label>
      <textarea id="input">
a/foo/bar/baz
b/haba/ca/dabra
c/hello/world
d/so/long/and/thanks/for/all/the/fish</textarea>
    </div>
    <div id="output-container">
      <label for="output">OUTPUT</label>
      <textarea id="output" disabled></textarea>
    </div>
  </div>
</main>

<script type="module" nonce="378acdg21a">
  /**
   * Split a command line string into its components
   *
   * e.g. --foo "hello world" -x '' -d 5
   * => ["--foo", "hello world", "-x", "", "-d", "5"]
   */
  function parse_args(args) {
    args = args.trim()

    let parts = ['']
    let in_single_quote = false
    let in_double_quote = false

    for (let c of args) {
      if (c === ' ' && !in_single_quote && !in_double_quote) {
        if (parts[parts.length - 1] !== '') {
          parts.push('')
        }
      } else if (c === '"') {
        if (in_double_quote) {
          // closing quotes, moving to next arg
          in_double_quote = false
          parts.push('')
        } else if (in_single_quote) {
          // no special meaning
          parts[parts.length - 1] += c;
        } else {
          // we are starting a double quoted string
          in_double_quote = true
          if (parts[parts.length - 1] !== '') {
            parts.push('')
          }
        }
      } else if (c === "'") {
        if (in_single_quote) {
          // closing quotes, moving to next arg
          in_single_quote = false
          parts.push('')
        } else if (in_double_quote) {
          // no special meaning
          parts[parts.length - 1] += c;
        } else {
          // we are starting a single quoted string
          in_single_quote = true
          if (parts[parts.length - 1] !== '') {
            parts.push('')
          }
        }
      } else {
        parts[parts.length - 1] += c;
      }
    }

    if (parts.length > 0 && parts[parts.length - 1] === '') {
      parts.pop()
    }

    if (parts.length === 1 && parts[0] === '') {
      return []
    }

    return parts
  }

  function buildImportModuleData() {
    let already_read = false;

    let stdin = new Stdio({
      read: (len) => {
        if (!already_read) {
          already_read = true
          return [new TextEncoder().encode(document.getElementById('input').value), 0]
        } else {
          return [new Uint8Array(), 0]
        }
      }
    })

    const stdout = new Stdio({
      write: (data) => {
        document.getElementById('output').value += new TextDecoder('utf-8').decode(data)
        return 0
      }
    })

    const stderr = new Stdio({
      write: (data) => {
        document.getElementById('output').value += new TextDecoder('utf-8').decode(data)
        return 0
      }
    })

    let cmd = document.getElementById('command-line').value.trim()
    if (cmd === '' || !cmd.startsWith('tuc')) {
      cmd = "tuc -h"
    }

    const args = parse_args(cmd);
    const env = ['RUSTC_LOG=trace', 'RUST_BACKTRACE=1'];
    const fds = [
      stdin,
      stdout,
      stderr,
      new PreopenDirectory('/tmp', {}),
    ];

    return [args, env, fds]
  }

  const debounce = (func, delay) => {
    let previousCallTime = Date.now() - delay
    let prevId = null

    return (...args) => {
      clearTimeout(prevId)
      const now = Date.now()

      if (previousCallTime + delay <= now) {
        func(...args)
      } else {
        prevId = setTimeout(() => func(...args), delay - (now - previousCallTime))
      }

      previousCallTime = Date.now()
    }
  }

  async function runTuc(wasmModule) {
    const [args, env, fds] = buildImportModuleData()
    const inst = await WASM_WASI_instantiate(wasmModule, args, env, fds);
    document.getElementById('output').value = ''

    try {
      inst.exports._start();
    } catch (e) {
      if (e.name !== 'WASIExit') {
        throw e;
      }
    }
  }

  (async function () {

    const wasmModule = await WebAssembly.compileStreaming(
      fetch('./tuc.wasm')
    );

    document.getElementById('input').addEventListener('input', debounce(() => runTuc(wasmModule), 70));
    document.getElementById('command-line').addEventListener('input', debounce(() => runTuc(wasmModule), 70));

    await runTuc(wasmModule)
  })();

</script>

</html>